name: Canary Deployment

on:
  workflow_dispatch:
    inputs:
      canary_percentage:
        description: 'Canary traffic percentage'
        required: true
        default: '10'
        type: choice
        options:
        - '10'
        - '25'
        - '50'
        - '100'

jobs:
  deploy-canary:
    name: Deploy Canary Version
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Deploy Canary Stack
        run: |
          cd infrastructure
          npm ci
          CANARY_STACK="ImagifyStack-Canary-${{ github.sha }}"
          cdk deploy $CANARY_STACK --require-approval never

      - name: Configure Traffic Split
        run: |
          # Update ALB listener rules for traffic splitting
          CANARY_TARGET_GROUP=$(aws cloudformation describe-stacks \
            --stack-name ImagifyStack-Canary-${{ github.sha }} \
            --query 'Stacks[0].Outputs[?OutputKey==`TargetGroupArn`].OutputValue' \
            --output text)
          
          PROD_TARGET_GROUP=$(aws cloudformation describe-stacks \
            --stack-name ImagifyStack-Prod \
            --query 'Stacks[0].Outputs[?OutputKey==`TargetGroupArn`].OutputValue' \
            --output text)
          
          # Create weighted routing
          aws elbv2 modify-listener \
            --listener-arn ${{ secrets.ALB_LISTENER_ARN }} \
            --default-actions '[
              {
                "Type": "forward",
                "ForwardConfig": {
                  "TargetGroups": [
                    {
                      "TargetGroupArn": "'$PROD_TARGET_GROUP'",
                      "Weight": '$((100 - ${{ github.event.inputs.canary_percentage }}))'
                    },
                    {
                      "TargetGroupArn": "'$CANARY_TARGET_GROUP'",
                      "Weight": ${{ github.event.inputs.canary_percentage }}
                    }
                  ]
                }
              }
            ]'

  monitor-canary:
    name: Monitor Canary Metrics
    runs-on: ubuntu-latest
    needs: deploy-canary
    
    steps:
      - name: Monitor for 10 minutes
        run: |
          echo "Monitoring canary deployment for 10 minutes..."
          
          for i in {1..20}; do
            # Check error rate
            ERROR_RATE=$(aws cloudwatch get-metric-statistics \
              --namespace AWS/ApplicationELB \
              --metric-name HTTPCode_Target_5XX_Count \
              --dimensions Name=LoadBalancer,Value=ImagifyStack-Canary \
              --start-time $(date -u -d '5 minutes ago' +%Y-%m-%dT%H:%M:%S) \
              --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
              --period 300 \
              --statistics Sum \
              --query 'Datapoints[0].Sum' \
              --output text)
            
            if [ "$ERROR_RATE" != "None" ] && [ "$ERROR_RATE" -gt 10 ]; then
              echo "::error::High error rate detected: $ERROR_RATE"
              echo "canary-status=failed" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            sleep 30
          done
          
          echo "canary-status=success" >> $GITHUB_OUTPUT

  promote-or-rollback:
    name: Promote or Rollback Canary
    runs-on: ubuntu-latest
    needs: monitor-canary
    if: always()
    
    steps:
      - name: Promote Canary
        if: needs.monitor-canary.outputs.canary-status == 'success'
        run: |
          echo "Promoting canary to 100% traffic..."
          # Switch all traffic to canary
          # Then rename canary to prod
          
      - name: Rollback Canary
        if: needs.monitor-canary.outputs.canary-status == 'failed'
        run: |
          echo "Rolling back canary deployment..."
          # Remove canary from load balancer
          # Delete canary stack
